<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>羽球社報到（穩定版）</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; padding: 18px; text-align: center; }
    .card { max-width: 560px; margin: 0 auto; padding: 18px; border: 1px solid #eee; border-radius: 16px; }
    .ok { color:#118a2a; font-weight:700; font-size: 20px; }
    .warn { color:#b45309; font-weight:700; font-size: 18px; }
    .err { color:#b91c1c; font-weight:700; font-size: 18px; }
    .tiny { font-size: 12px; color:#666; margin-top: 10px; white-space: pre-wrap; word-break: break-word; }
    button { padding: 10px 14px; border-radius: 12px; border: 1px solid #ddd; background: white; cursor: pointer; }
  </style>
</head>
<body>
  <div class="card">
    <h2>羽球社報到</h2>
    <div id="msg">初始化中…</div>
    <div class="tiny" id="debug"></div>
    <div style="margin-top:14px;">
      <button id="retry">重新嘗試</button>
    </div>
  </div>

<script>
  // ✅ 你這個 LIFF ID 正確
  const LIFF_ID = "2008684760-00HydtQU";

  // ✅ 一定要用 googleusercontent 版本（避免 iOS LINE WebView 的 Load failed）
  const GAS_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLjFh2Tjifuf8Pz-G7BS6OwKyRcHhJ9OkPZA2SOLCA6RjozR5eaf0wGwcZW3142aD9SXi8Qa2MnxHtOC8wnKCtljRsqndJbD1C4bWNqBb9dzT8R71OHVsP9ns3DDZ80iUkwbhS7WWeeG5DMONENt2bqXQORoNxeLuXs2ggLDskQXpk9fJlJd1Buv8Nsc1u1uACkOeJ688vgEShkrYnbC5UrUgf3z1Ktv7_WhSNW9qT_CBT1MxnrVpeviKyPXJV1s1ChZjlF0TuDKnHUU-ZAJNbuQY0CnNdRIgtnhjocj&lib=Mwm8c4qqIwIXnQhZGz2CcPjj3n-T0tf8J";

  const el = (id) => document.getElementById(id);

  function qp(name) {
    return new URLSearchParams(location.search).get(name);
  }

  function sessionLabel(session) {
    if (session === "THU") return "週四場";
    if (session === "SAT") return "週六場";
    return session;
  }

  // ✅ 用 form POST（hidden iframe）送出，避開 CORS / fetch 被擋
  function postViaForm(url, data) {
    const iframeName = "gas_hidden_iframe";
    let iframe = document.querySelector(`iframe[name="${iframeName}"]`);
    if (!iframe) {
      iframe = document.createElement("iframe");
      iframe.name = iframeName;
      iframe.style.display = "none";
      document.body.appendChild(iframe);
    }

    const form = document.createElement("form");
    form.method = "POST";
    form.action = url;
    form.target = iframeName;

    for (const [k, v] of Object.entries(data)) {
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = k;
      input.value = v;
      form.appendChild(input);
    }

    document.body.appendChild(form);
    form.submit();
    form.remove();
  }

  async function run() {
    el("msg").innerHTML = "啟動 LIFF 中…";
    el("debug").textContent = "";

    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    const session = qp("session") || "THU";

    const payload = {
      line_user_id: profile.userId,
      display_name: profile.displayName,
      session: session
    };

    // 顯示 debug（方便你確認 session 有沒有對）
    el("debug").textContent =
      `session=${session}\nuserId=${profile.userId}\nname=${profile.displayName}\nGAS=${GAS_URL.substring(0,60)}...`;

    el("msg").innerHTML = `送出報到中…（${sessionLabel(session)}）`;

    // ✅ 送出（不會被 iOS LINE WebView 擋）
    postViaForm(GAS_URL, payload);

    // ✅ 送出即提示成功（實際以 Sheet 有沒有新增為準）
    el("msg").innerHTML = `<div class="ok">✅ 已送出報到（${sessionLabel(session)}）</div>
    <div class="tiny">請到 Google 試算表的 checkins 分頁確認是否新增一筆。</div>`;
  }

  el("retry").addEventListener("click", () => {
    run().catch(err => {
      el("msg").innerHTML = `<div class="err">❌ 發生錯誤：${String(err)}</div>`;
      el("debug").textContent = "";
    });
  });

  run().catch(err => {
    el("msg").innerHTML = `<div class="err">❌ 發生錯誤：${String(err)}</div>`;
    el("debug").textContent = "";
  });
</script>
</body>
</html>
